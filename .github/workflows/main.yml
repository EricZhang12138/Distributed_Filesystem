name: Build and Test AFS  # name of the module

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  test:  # name of this specific job
    runs-on: ubuntu-latest
    steps:
    - name: Copy code
      uses: actions/checkout@v4  # uses a reusable action, in this case, clone the code from the repo to github action

    - name: Create Build Directory
      run: |
        mkdir -p build

    - name: Install Dependencies
      run: | 
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          pkg-config \
          libfuse-dev \
          protobuf-compiler \
          libprotobuf-dev \
          libgrpc++-dev \
          libprotoc-dev \
          protobuf-compiler-grpc \
          libboost-all-dev
  
    - name: Configure cmake
      run: |
        cd build 
        cmake ..

    - name: Configure Make
      run: |
        cd build
        make
  
    - name: Run Test 1
      run: | 
        cd build
        mkdir -p server_test
        ./afs_server ./server_test &     # 1. Start the server in the background (& ensures this is running in the background)
        SERVER_PID=$!      # 2. Capture the process ID

        echo "Waiting for server to start..."
        sleep 3

        #4. Run the test client
        ./client_test

        kill $SERVER_PID

    - name: Run callback_test
      run: |
        cd build
        mkdir -p server_test
        ./afs_server ./server_test &
        
        SERVER_PID=$!

        echo "Waiting for server to start ..."
        sleep 3

        ./register_test

        kill $SERVER_PID
    
    - name: Run Tests on three containers
      run: |
        docker compose build afs_server
        docker compose up

        # Get exit codes from test clients
        EXIT_CODE_1=$(docker inspect test_client_1_node --format='{{.State.ExitCode}}')
        EXIT_CODE_2=$(docker inspect test_client_2_node --format='{{.State.ExitCode}}')

        echo "Test Client 1 exit code: $EXIT_CODE_1"
        echo "Test Client 2 exit code: $EXIT_CODE_2"

        # Fail the workflow if either test client failed
        if [ "$EXIT_CODE_1" -ne 0 ] || [ "$EXIT_CODE_2" -ne 0 ]; then
          echo "One or more test clients failed"
          exit 1
        fi

        echo "All tests passed successfully"

  build-and-push:
    needs: test
    runs-on: self-hosted
    steps: 
    - uses: actions/checkout@v2
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build Docker Image
      run: docker build -t server .
    - name: tag for registry
      run: docker tag server ghcr.io/ericzhang12138/fs_server
    - name: push to registry
      run: docker push ghcr.io/ericzhang12138/fs_server
    # CRITICAL STEP: Clean up to prevent SD card from filling up
    - name: Prune Docker System
      if: always()  # Run this even if the build fails
      run: docker system prune -f

  deploy: 
    needs: build-and-push
    runs-on: self-hosted
    steps:
    - name: Run Ansible playbook to deploy filesystem server
      run: ansible-playbook -i inventory.ini deploy.yml \
           --extra-vars "github_username = EricZhang12138"
           --extra-vars ""
    # - name: Log in to GitHub Container Registry
    #   uses: docker/login-action@v3
    #   with:
    #     registry: ghcr.io
    #     username: ${{ github.actor }}
    #     password: ${{ secrets.GITHUB_TOKEN }}

  
    # - name: Deploy Docker Container
    #   run: |
    #     echo "Filesystem server container arrives"
        
    #     # Navigate to your persistent directory on the Pi
    #     cd ~/Documents/afs_server_deploy
        
    #     # Pull the new image
    #     docker pull ghcr.io/ericzhang12138/fs_server
        
    #     # Stop and remove the old container (ignoring errors if it doesn't exist)
    #     docker stop fs_server || true
    #     docker rm fs_server || true
        
    #     # Run the new container
    #     docker run -d --name fs_server \
    #       -p 50051:50051 \
    #       -v $(pwd):/Filesystems/Test_env/Filesystem_server \
    #       ghcr.io/ericzhang12138/fs_server ./afs_server ../Test_env/Filesystem_server







