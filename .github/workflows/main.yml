name: Build and Test AFS  # name of the module

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  dependency_setup:  # name of this specific job
    runs-on: ubuntu-latest

    steps:
    - name: Copy code
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: | 
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          pkg-config \
          libfuse-dev \
          protobuf-compiler \
          libprotobuf-dev \
          libgrpc++-dev \
          libprotoc-dev \
          protobuf-compiler-grpc

    - name: Configure cmake
      run: |
        cd build 
        cmake ..

    - name: Configure Make
      run: make

    - name: Run Test
      run: | 
        cd build
        # 1. Start the server in the background (& ensures this is running in the background)
        ./afs_server &

        # 2. Capture the process ID
        SERVER_PID = $!

        echo "Waiting for server to start..."
        sleep 3

        #4. Run the test client
        ./afs_test

        kill $SERVER_PID

