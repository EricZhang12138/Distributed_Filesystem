syntax = "proto3";
package afs_operation;


message MakeDir_request{
    string directory = 1;
    int32 mode = 2;
}
message MakeDir_response{
    bool success =1;
}

message Delete_request{
    string directory = 1;
}
message Delete_response{
    bool success = 1;
}

message RenameRequest {                // for rename calls 
    string filename = 1;     // Current name
    string new_filename = 2; // New name
    string directory = 3;
    string new_directory = 4;
}

message RenameResponse {
    bool success = 1;
}

message InitialiseRequest{
    string code_to_initialise = 1;
    string client_id = 2;
}
message InitialiseResponse{
    string root_path = 1;
}

message FileRequest {
    string filename = 1;
    int64 timestamp = 2;
    bytes content = 3;
    string directory = 4;
}

message FileResponse {
    bytes content = 1;
    int32 length = 2;
    int64 timestamp = 3;
    int32 update_bit =4;  // update = 1 -> needs to update content on the client otherwise no
}

message ListDirectoryRequest{
    string directory =1;
}

message ListDirectoryResponse{
    map<string,string> entry_list =1;
}

message GetAttrRequest {
    string filename = 1;
    string directory = 2;
}

message GetAttrResponse {
    int64 size = 1;         // File size in bytes
    int64 mtime = 2;        // Last modification time (nanoseconds)
    uint32 mode = 3;        // File mode (e.g., 0755 | S_IFREG)
    int64 atime = 4;        // Last access time (nanoseconds)
    int64 ctime = 5;        // Last status change time (nanoseconds)
    uint32 nlink = 6;       // Number of hard links
    uint32 uid = 7;         // User ID
    uint32 gid = 8;         // Group ID
}


message SubscribeRequest {
  string client_id = 1;
  // No file_ids here!
}


message Notification {
    string filename = 1;
    string directory = 2;    // Useful to distinguish files with same name in different folders
    string message = 3;      // e.g. "UPDATE", "DELETE", "RENAME"
    int64 timestamp = 4;     // The last time the file was changed recorded on the server to update the version of the file in cache
    string content = 5;
}




service operators{
    rpc request_dir (InitialiseRequest) returns (InitialiseResponse);
    rpc open (FileRequest) returns (stream FileResponse);
    rpc close (stream FileRequest) returns (FileResponse);
    rpc compare (FileRequest) returns (stream FileResponse);
    rpc ls (ListDirectoryRequest) returns (ListDirectoryResponse);
    rpc getattr (GetAttrRequest) returns (GetAttrResponse);
    rpc rename (RenameRequest) returns (RenameResponse);
    rpc mkdir (MakeDir_request) returns (MakeDir_response);
    rpc unlink (Delete_request) returns (Delete_response);
    rpc Subscribe(SubscribeRequest) returns (stream Notification);
}



